DROP TABLE PEDIDO_VENDAPAGAR;

DROP TABLE PEDIDO_VENDAITENS;

DROP TABLE PEDIDO_VENDA;

CREATE TABLE PEDIDO_VENDA (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY,
    EMISSAO DATE NOT NULL,
    ENTRADA TIMESTAMP NOT NULL,
    ENTREGA DATE,
    ID_CLIENTE INTEGER NOT NULL);

ALTER TABLE PEDIDO_VENDA
ADD CONSTRAINT PK_PEDIDO_VENDA
PRIMARY KEY (ID);

ALTER TABLE PEDIDO_VENDA
ADD CONSTRAINT FK_PEDIDO_VENDA_CLIENTE
FOREIGN KEY (ID_CLIENTE)
REFERENCES CLIENTE(CODIGO)
ON DELETE SET NULL
ON UPDATE CASCADE;

ALTER TABLE PEDIDO_VENDA
    ADD ID_VENDEDOR INTEGER;

ALTER TABLE PEDIDO_VENDA
ADD CONSTRAINT FK_PEDIDO_VENDA_1
FOREIGN KEY (ID_VENDEDOR)
REFERENCES REPRESENTANTE(CODIGO)
ON DELETE SET NULL
ON UPDATE CASCADE;

ALTER TABLE PEDIDO_VENDA DROP CONSTRAINT FK_PEDIDO_VENDA_1;

ALTER TABLE PEDIDO_VENDA
ADD CONSTRAINT FK_PEDIDO_VENDA_VENDEDOR
FOREIGN KEY (ID_VENDEDOR)
REFERENCES REPRESENTANTE(CODIGO)
ON DELETE SET NULL
ON UPDATE CASCADE
USING INDEX FK_PEDIDO_VENDA_1;

CREATE TABLE PEDIDO_VENDA_STATUS (
    ID_PEDIDO INTEGER NOT NULL,
    ORDEM INTEGER NOT NULL,
    STATUS VARCHAR(50) NOT NULL,
    USUARIO VARCHAR(30) NOT NULL,
    DATA_HORA TIMESTAMP NOT NULL);

ALTER TABLE PEDIDO_VENDA_STATUS
ADD CONSTRAINT PK_PEDIDO_VENDA_PEDIDO
PRIMARY KEY (ID_PEDIDO,ORDEM);

CREATE TABLE CONTAS_A_RECEBER (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY,
    TIPO INTEGER DEFAULT 1 NOT NULL,
    ID_TABELA_MASTER INTEGER,
    ID_CONTA CHAR(5) NOT NULL,
    ID_HISTORICO INTEGER NOT NULL,
    NDUP INTEGER NOT NULL,
    VDUP NUMERIC(15,2) NOT NULL,
    VDESC NUMERIC(15,2),
    VJUROS NUMERIC(15,2),
    DVENC DATE NOT NULL);

ALTER TABLE CONTAS_A_RECEBER
ADD CONSTRAINT PK_CONTAS_A_RECEBER
PRIMARY KEY (ID);

COMMENT ON COLUMN CONTAS_A_RECEBER.TIPO IS
'PEDIDO_VENDA=1';

CREATE TABLE CONTAS_A_RECEBER_LOG (
    ID_CONTASRECEBER INTEGER NOT NULL,
    ORDEM INTEGER NOT NULL,
    USUARIO VARCHAR(30) NOT NULL,
    COMANDO VARCHAR(50) DEFAULT 'BAIXA' NOT NULL,
    DATA_HORA TIMESTAMP DEFAULT current_timestamp NOT NULL);

COMMENT ON COLUMN CONTAS_A_RECEBER_LOG.COMANDO IS
'BAIXA
RESTAURACAO
PARCIAL';

ALTER TABLE CONTAS_A_RECEBER_LOG
ADD CONSTRAINT PK_CONTAS_A_RECEBER_LOG
PRIMARY KEY (ID_CONTASRECEBER,ORDEM);

ALTER TABLE PEDIDO_VENDA
    ADD OBSERVACAO VARCHAR(500);

CREATE TABLE PEDIDO_VENDA_ITEM (
    ID_PEDIDO INTEGER NOT NULL,
    ORDEM INTEGER NOT NULL,
    ID_PRODUTO INTEGER NOT NULL,
    VUNIT NUMERIC(15,2) NOT NULL,
    QTDE NUMERIC(15,4) NOT NULL,
    UNIDADE VARCHAR(10) NOT NULL,
    QTDE_BAIXA NUMERIC(15,4) NOT NULL,
    VDESC NUMERIC(15,2),
    SUBTOTAL NUMERIC(15,2),
    TOTAL NUMERIC(15,2));

ALTER TABLE PEDIDO_VENDA_ITEM
ADD CONSTRAINT PK_PEDIDO_VENDA_ITEM
PRIMARY KEY (ID_PEDIDO,ORDEM);

ALTER TABLE PEDIDO_VENDA_ITEM
ADD CONSTRAINT FK_PEDIDO_VENDA_ITEM_1
FOREIGN KEY (ID_PRODUTO)
REFERENCES PRODUTO(CODIGO)
ON DELETE SET NULL
ON UPDATE CASCADE;

ALTER TABLE PEDIDO_VENDA_ITEM DROP CONSTRAINT FK_PEDIDO_VENDA_ITEM_1;

ALTER TABLE PEDIDO_VENDA_ITEM
ADD CONSTRAINT FK_PEDIDO_VENDA_ITEM_PRODUTO
FOREIGN KEY (ID_PRODUTO)
REFERENCES PRODUTO(CODIGO)
ON DELETE SET NULL
ON UPDATE CASCADE
USING INDEX FK_PEDIDO_VENDA_ITEM_1;

SET TERM ^ ;

CREATE trigger tri_ai_pedido_venda_item for pedido_venda_item
active after insert position 0
AS
begin
  execute procedure PRO_ENTRADA_SAIDA(new.ID_PRODUTO,new.QTDE_BAIXA,'-') ;
end^

SET TERM ; ^

SET TERM ^ ;

CREATE trigger tri_au_pedido_venda_item for pedido_venda_item
active after update position 0

as
begin
  execute procedure PRO_ENTRADA_SAIDA(old.ID_PRODUTO, old.QTDE_BAIXA, '+');
  execute procedure PRO_ENTRADA_SAIDA(new.ID_PRODUTO, new.QTDE_BAIXA, '-');
end^

SET TERM ; ^

SET TERM ^ ;

CREATE trigger tri_ad_pedido_venda_item for pedido_venda_item
active after delete position 0

as
begin
  execute procedure PRO_ENTRADA_SAIDA(old.ID_PRODUTO, old.QTDE_BAIXA, '+');
end^

SET TERM ; ^

ALTER TABLE PEDIDO_VENDA ALTER COLUMN EMISSAO
SET DEFAULT CURRENT_DATE;

ALTER TABLE PEDIDO_VENDA ALTER COLUMN ENTRADA
SET DEFAULT CURRENT_TIMESTAMP;






